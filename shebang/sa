#!/usr/bin/env bash

if ! is_command fzf; then
    >&2 echo "sa requires fzf"
fi

green="$(tstyle -t green)"
gray="$(tstyle -t gray)"
reset="$(tstyle -t reset)"

# Can't use files with colons in the name since colons are used as separators, but I don't think this will negatively affect things often
file_number_line="$(find . -type f -not -path '*/\.git/*' | sort | grep -v :  | while read -r file; do
    cat --number "$file" | while read -r line; do
        readarray -d'	' array <<< "$line"
        echo -n "$green$file$gray:${array[0]}$reset${array[*]:1}"
    done
done | fzf --ansi --reverse)"

if [ -n "$file_number_line" ]; then
    file="$(echo "$file_number_line" | cut -d':' -f1)"
    number="$(echo "$file_number_line" | cut -d':' -f2 | cut -f1)"

    nvim +"$number" "$file"
fi
